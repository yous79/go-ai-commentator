# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 9.2

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。
3.  **解説の論理的深度の向上**: **統合知能モード**により、AIが自らKataGoのデータを深掘りし、戦略的意図を言語化する。

## 2. アーキテクチャ定義 (Modular MVC & Autonomous Agent)
システムは、静的なデータ表示（MVC）と、自律的な思考（Agent）のハイブリッド構成へと進化。

- `src/core/`: 不変の囲碁ロジック（GameState, 座標変換）。独自メモリ管理による表示・データの完全同期。
- `src/services/`: 
    - `AnalysisManager`: 解析フロー制御。Atomic Writeによるデータ保護。
    - `ImageWriter`: 画像生成・保存を専門に行うバックグラウンド・ワーカー。
    - **`GeminiCommentator`**: 単なる解説生成器から、KataGoを自在に操る **「自律型Agent」** へと昇格。
- `src/gui/`: 部品化されたUIコンポーネント。ThreadPoolExecutorによる非同期タスク管理。
- `src/prompts/`: 解析と解説を統合した、プロ棋士の思考プロセスを定義する **Unified Prompt** 体系を採用。
- `src/drivers/`: KataGoプロセスとの低レイヤー通信。Double-Checked Lockingによるスレッドセーフなシングルトン。

## 3. シングルトン・エンジン・プロトコル
PCリソースの競合を防ぎ、通信の安定性を担保するため、1つのKataGoプロセスをアプリ全体で共有する。

- **スレッドセーフ初期化**: インスタンス生成時の競合を防ぎ、アプリ全体で唯一のプロセスを保証する。
- **優先制御 (Priority Locking)**: Agent解析（ユーザー操作）を最優先とする。
- **譲歩ロジック**: バックグラウンド解析はAgent解析の要求を検知した瞬間、即座に処理権を譲る（Yield）。

## 4. AI解説生成：統合知能プロトコル (Integrated Intelligence)
**「嘘（ハルシネーション）の物理的封殺」から「知性の解放と自律的検証」へのパラダイムシフト。**

1.  **自律的解析ループ (ReAct)**: Geminiが自らの思考に基づき `consult_katago_tool` を呼び出す。必要に応じて複数回の解析を行い、納得のいく結論（解説）を導き出す。
2.  **文脈の永続化 (Contextual Continuity)**: 過去の解析結果や対話の履歴を保持。これにより「さっきの指摘がこの局面で活きている」といった、対局全体を通した一貫性のある指導が可能。
3.  **高解像度フィードバック**: 最善手だけでなく、複数の候補手（Top 3）とそのPVすべてをGeminiに供給し、プロレベルの「比較検討」を行わせる。
4.  **動的ガード (Dynamic Verification)**: 数値の捏造を防ぐため、生成された解説内の評価値とツールが返した実データをシステム側で照合可能な状態に保つ。

## 5. 知識ベースの活用規約
- **効率的参照**: 起動時に知識ベースをメモリにロード（キャッシュ）し、推論ごとのディスクI/Oを排除する。
- **例題ルール**: 知識ベース内の座標（E6等）は「サンプル」であり、回答への混入を厳禁とする。
- **着手番号の義務化**: 用語を指摘する際は、履歴内の具体的な着手番号（例：黒#15）との紐付けを必須とする。
- **厳格な出現判定**: 
    - 知識ベースにある愚形が実際の局面またはPV内に現れた場合は、**「確実に」** 言及する。
    - 現れていない局面での汎用的な助言（ノイズ）は避け、目の前の局面に集中する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **Black Perspective Policy**: KataGoからの出力はドライバー層で即座に「黒番視点」に完全正規化され、以降の全レイヤー（GameState, Storage, UI）で一貫して保持される。
- 手番による反転処理は、データの生成・保存の瞬間にのみ行い、GUI層やAI Engine層では一切の計算・反転を行わない。

## 7. 開発デバッグ・堅牢性指針
- **Atomic Storage**: JSON保存は一時ファイルへの書き込み完了後にリネームを行うことで、読み込み中の破損を物理的に防ぐ。
- **詳細ログ・トレーサビリティ**: `katago_debug.log` と `katago_err.log` を分離し、トラブルシューティングを迅速化する。
- **変更時強制検証ルール (Modification Guard)**: 
    - コード修正後は、必ず `python -m py_compile` による構文チェックを実施すること。
    - 加えて、`python src/main.py` を実行し、初期化フェーズでの例外発生がないこと、およびGUIの正常起動を都度確認することを義務付ける。
- **リソースクリーンアップ**: アプリ終了時にワーカースレッド and エンジンプロセスを確実に停止させる。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **戦略的ストーリーテリング**: 数値の羅列を避け、「石の重さ」「地の価値」「攻防の急所」といった抽象的概念を用いた物語的な解説を行う。
- **候補手比較の義務化**: なぜ最善手が他の候補より優れているのか、その「差」を論理的に言語化させる。
- **AIによるPVの解釈**: 推奨図の最後にどのような戦略的メリット（厚み、地、先手後手）があるかを、Geminiの戦略的知性で解釈させる。
- **流れ（トレンド）の指摘**: 一手ごとの点ではなく、数手を通じた形勢の推移を「物語」として解説する。
