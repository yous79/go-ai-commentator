# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 14.0

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。
3.  **解説の論理的深度の向上**: ハイブリッド検知と **gemini-3-flash-preview** の高度な推論能力を融合させ、より人間味のある対話型指導を実現する。

## 2. アーキテクチャ定義 (Resident API-Centric Platform)
システムは、核となる解析エンジンを独立した常駐プロセス（API）に集約し、各インターフェースがそのサービスを共有する「サービス指向アーキテクチャ」を採用する。

- **`src/katago_api.py` (Core Intelligence Service)**: 
    - **Single Point of Control**: 唯一の KataGo プロセスを管理し、HTTP API (localhost:8000) を通じて解析を提供。
    - **Intelligence Hub**: 形勢判断、形状検知、将来予測、およびデータサニタイズを統合。
- **`src/mcp_server.py` (Lightweight Proxy)**: 
    - Gemini CLI 等の外部ツールに対し、常駐APIへの標準化された窓口を提供。自身はエンジンプロセスを持たない。
- **`src/gui/app.py` (Main Frontend)**: 
    - 起動時に API の死活を監視し、自動起動・接続を行う。

## 3. エンジン・マネジメント・プロトコル
- **プロセスの完全分離**: GUIアプリやCLIクライアントが `KataGoDriver` を直接生成することを厳禁とし、必ず `katago_api` を経由して解析を行わなければならない。
- **リソース競合の解決**: APIサーバー側でリトライロジックを備え、複数クライアントからの要求を安全に処理する。

## 4. AI解説生成：統合知能プロトコル (Autonomous Intelligence)
1.  **データ可読性の最大化**: ツール結果は JSON オブジェクトとして Gemini に直接渡され、モデルが数値を「データ」として正確に認識できるようにする。
2.  **推論と事実の融合**: 「過去の推論を捨てろ」ではなく「最新の事実でこれまでの洞察を洗練せよ」と指示し、AIの知性を活かした深い解説を促す。
3.  **自動関数呼び出し (Auto-FC)**: Geminiが自律的にツールを呼び出し、その結果を論理的に解釈して解説を構成する。

## 5. 知識ベースの活用・検知規約
- **階層化知識ベース**: 知識を「悪形・失着（重要）」と「一般手筋・概念（一般）」に分類し、Geminiに重要度をディレクトリ構造から理解させる。
- **プラグイン方式の検知**: `src/core/shapes/` 配下の各ストラテジーが、共通の座標変換ロジックを介して事実を抽出する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、各コンポーネントは履歴から自律的に盤面を再構築する。
- **Black Perspective (Standardized)**: API出力のキー名を **`winrate_black`**, **`score_lead_black`** に固定し、Geminiの推測による視点逆転を物理的に排除する。

## 7. 開発デバッグ・堅牢性指針 (Robustness & Resilience)
- **バックオフ・リトライ (Retry with Backoff)**: クライアントはAPIエラー発生時に指数バックオフを用いた自動リトライを行い、一時的な負荷による解析停止を防止する。
- **自動起動検証 (Automated Startup Test)**: 修正後は必ず `python src/utils/check_startup.py` を実行し、合格を確認すること。
- **文字コード保護**: 日本語プロンプトを含むファイル保存時は UTF-8 を明示する。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **表現の具体化と一貫性**: 「重い・軽い」を禁止し、「強い石（安定）」「弱い石（不安定）」という実戦的表現に統一する。
- **gemini-3-flash-preview の最大活用**: モデルの最新推論能力を活かし、数値の背後にある「戦略的意図」を深く言語化させる。
- **将来予測の活用**: 変化図の先で起きる事実を根拠に、着手の是非を語らせる。