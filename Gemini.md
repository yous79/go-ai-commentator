# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 21.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: いかなる状況下でもモデル名称を誤認、あるいは旧世代名と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

## 2. 形状検知ロジックの究極的厳密性 (Logic Rigor)
形状検知は単なるパターン照合ではなく、囲碁の本質である「先制」と「効率」の論理に従う。

### 2.1 二目の頭 (Nimoku no Atama) の決定版定義
- **先制の原則 (Priority)**: 相手に叩かれた際、反対側の急所が「空点」である場合のみ検知する。双方で叩き合っている（切り違い等）場合は除外する。
- **急所の孤立性 (Isolation)**: 叩いている石の周囲8マスに、防御側（自分）の石が一切存在しないこと（二目自身を除く）。
- **自軍の純粋性**: 対象となる自軍の石は、直線状に「厳密に2つ」並んでいること。

### 2.2 サカレ形 (Sakare Gata) の分断証明
- **8近傍BFSによる断絶**: 自分の2石（一間トビ・ケイマ）の間に相手が割り込み、かつ8近傍探索によって「物理的な連絡経路が完全に絶たれている」ことが証明された場合のみ検知する。

## 3. 統合検知アーキテクチャ (Integrated Detection)
- **同時多角的評価**: `ShapeDetector` は、一つの局面に対して全ての検知戦略を同時に実行する。
- **検知の空白地帯の排除**: 特定の Detector が厳密化により沈黙しても、他の Detector が補完することで盤面の悪さをあぶり出す。

## 4. アーキテクチャと信頼性 (Infrastructure)
- **MVCパターンの遵守**: 表示 (View: app.py)、制御 (Controller: controller.py)、通信 (APIClient: api_client.py) を分離して管理する。
- **自律的ライフサイクル管理**: 起動時に古いプロセスを自動クリーンアップし、APIサーバーを自律起動する。
- **統合構造化ロギング**: 全ての動作をレイヤー別に `system.log` およびコンソールに出力する。

## 5. AI解説生成：事実先行プロトコル (Fact-First Protocol)
- 確定事実（解析データ・形状検知結果）をプロンプト最上部に配置。**Gemini 3 Flash Preview** は、提供された正確なデータに基づく戦略的言語化に集中する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、不完全なデータ（None値）や画像読み込みエラーを安全に処理する。

## 7. 開発デバッグ・堅牢性指針 (Verification Standards)
- **二重検証義務**: コード変更後は必ず以下を実行し、合格を確認すること。
    1. `python src/utils/check_startup.py` (インフラ確認)
    2. `python tests/unit/test_shapes.py` (形状検知論理確認)

## 8. 解説品質向上への注力事項
- 視覚的コンテキストの統合、および将来予測に基づく論理的解説の強化。

## 9. 復旧プロトコル (Recovery Protocol) - [改定不可]
開発プロセスにおいて論理的整合性が失われたり、修復困難なエラーが発生した場合の対応指針。

1. **独断実行の禁止**: エージェントはいかなる状況下でも、**ユーザーの明示的な許可（例：「リセットしてください」等の指示）なしに** `git reset --hard` 等の破壊的コマンドを実行してはならない。
2. **復旧の提案**: 混乱やデグレードを検知した場合、エージェントはユーザーに対し「最後にプッシュされた正常な状態（origin/main）への強制復旧」を速やかに提案すること。
3. **強制リセットの手順 (許可取得後)**:
   - `git fetch origin && git reset --hard origin/main`
   - 全プロセスの強制終了: `powershell.exe -NoProfile -Command "taskkill /F /IM python.exe /T; taskkill /F /IM katago.exe /T"`
4. **正常性の再証明**: 復旧後は必ず `python tests/unit/test_shapes.py` を実行し、全テストの合格を確認すること。

## 10. 開発プロセス：提案・承認プロトコル (Proposal-First Protocol) - [改定不可]
開発の透明性を確保し、デグレードや意図しない変更を防止するための絶対手順。

1. **実装前の提案義務**: エージェントは、コードの修正、新機能の追加、ファイルの作成を行う前に、必ず具体的な「実装案」をユーザーに提示しなければならない。
2. **案に含めるべき項目**: 
   - アルゴリズムやロジックの詳細
   - 修正・作成対象となるファイルパス
   - 期待される動作と影響範囲
3. **承認の待機**: ユーザーから明示的な承認（例：「その案で進めてください」「実装をお願いします」等）を得るまで、ツールを用いた実際のファイル操作を開始してはならない。
4. **例外**: 既存ファイルの単純な読み込み（read_file）や検索（search_file_content）などの調査活動は、承認なしに実行可能である。