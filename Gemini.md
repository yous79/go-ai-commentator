# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 18.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: エージェントはいかなる状況下でもモデル名称を誤認、あるいは旧世代名（Gemini 1.5/2.0等）と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

## 2. 知識ベースの論理的厳密性 (Knowledge Rigor) - [Rev 18.0 強化]
知識ベースの検知ロジックは、単なるパターンマッチングではなく、以下の厳格な位置関係の論理に従う。

### 2.1 二目の頭 (Nimoku no Atama) の厳格定義
- **自軍の純粋性**: 対象となる自軍の石は、直線状に **「厳密に2つ」** 並んでいること（3つ以上の連の一部である場合は除外）。
- **相手の並走条件**: 自軍の二目の真横に、相手の石が **「2つ以上」** 連続して並んでいること。
- **ハネの確定**: 相手の並走ラインの先端から、自軍の二目の頭（3点目）を斜めに抑え込んでいる（ハネている）こと。
- **手順の不問**: 相手に叩かれたか、自らぶつかったかに関わらず、最終的な形状が上記を満たせば「二目の頭」として検知・解説する。

## 3. アーキテクチャ定義 (Intelligence Hub & Reliability)
- **動的SGFコンテキスト (`mcp://game/current/sgf`)**: GUIとAPIサーバーのリアルタイム同期により、AIは現在の手数やメタデータを常に把握する。
- **リソース指向知識ベース**: `mcp://knowledge/` を通じて、AIは検知された形状の「公式定義」と「反例（ではない方）」を即座に参照する。

## 4. AI解説生成：事実先行プロトコル (Fact-First Protocol)
1.  **先行解析 (Pre-Analysis)**: ユーザーの要求に対し、プログラムが自律的に解析ツールを実行し、勝率、目数、形状予測、幾何学的形状等の確定事実を取得する。
2.  **事実の文脈注入 (Fact Injection)**: 取得したデータをプロンプトの最上部に配置。**Gemini 3 Flash Preview** に対し「数字を予想・捏造する」動機を物理的に排除する。
3.  **純粋な解釈フェーズ**: AIは提供された正確なデータをどう級位者に納得させるかという、戦略的言語化（意味付け）に集中する。

## 5. 知識ベースの活用・検知規約
- **階層化管理**: 知識を「悪形・失着（重要）」と「一般手筋（一般）」に分類。
- **ハイブリッド検知**: `ShapeDetector` が抽出した事実に対し、AIがその理由を知識ベースを引用して解説する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、必要に応じて動的に復元する。
- **Partial Data Resilience**: 並列解析中はデータが不完全な（穴あき）状態であることを前提とし、各コンポーネントは `None` 値を安全にスキップまたは補完しなければならない。

## 7. 開発デバッグ・堅牢性指針 (Verification Standards)
- **非同期例外の可視化**: すべてのバックグラウンドタスクは `traceback.print_exc()` による例外出力を行い、「沈黙するエラー」を徹底排除する。
- **二重検証義務**: コード変更後は必ず以下を実行し、合格を確認すること。
    1. `python src/utils/check_startup.py` (プロセスの起動確認)
    2. `python src/utils/verify_sgf_flow.py` (解析データの整合性確認)
- **同期の信頼性**: GUIからAPIへの `/game/state` 同期が確実に行われていることを、随時 `curl` 等で検証する。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **視覚的コンテキストの統合**: 勝率グラフ上の変化点（急落・急騰）をクリックすることで、その瞬間の事実と紐付けた深い検討を可能にする。
- **表現の具体化**: 「重い・軽い」を禁止し、「強い石（安定）」「弱い石（不安定）」という用語を使用する。
- **将来予測の活用**: **Gemini 3 Flash Preview** の高度な推論能力を活かし、変化図の先で起きる事実を根拠に、着手の是非を論理的に語らせる。