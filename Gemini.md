# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 12.0

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。
3.  **解説の論理的深度の向上**: **統合知能モード**により、AIが自らKataGoのデータを深掘りし、戦略的意図を言語化する。

## 2. アーキテクチャ定義 (Unified MCP Ecosystem)
システムは、核となる解析エンジンを **MCP (Model Context Protocol)** サーバーとして独立させ、GUIアプリやCLIツールからプラグイン形式で利用する構成を採用する。

- **`src/mcp_server.py`**: 
    - **Single Source of Intelligence**: KataGo解析、幾何学形状検知、将来予測のすべてを統合したサーバー。
    - 提供ツール: `katago_analyze`, `detect_shapes`。
- **`src/services/AICommentator`**: 
    - MCPクライアントとして動作し、Gemini SDKの自動関数呼び出しを通じてサーバーと連携する。
- **`src/core/`**: 
    - `BoardSimulator`, `ShapeDetector`: MCPサーバーが利用するステートレスな計算ロジック。

## 3. シングルトン・エンジン・プロトコル
PCリソースの競合を防ぎ、通信の安定性を担保するため、1つのKataGoプロセスをアプリ全体（およびMCP経由の全クライアント）で共有する。

## 4. AI解説生成：MCP統合プロトコル (MCP-Powered Intelligence)
1.  **プロトコルの一貫性**: GUIとCLIで全く同じ解析ロジック（MCPツール）を使用し、解説の質を統一する。
2.  **自動関数呼び出し (Auto-FC)**: Geminiが自律的に `katago_analyze` または `detect_shapes` を呼び出し、その結果を論理的に解釈して解説を構成する。
3.  **データサニタイズ**: LLMからの不正な座標形式や履歴リストをMCPサーバー側で自動修正し、解析の堅牢性を維持する。

## 5. 知識ベースの活用・検知規約
- **階層化知識ベース**: 知識を「悪形・失着（重要）」と「一般手筋・概念（一般）」に分類し、Geminiに重要度をフォルダ構造から理解させる。
- **厳格な出現判定**: 検知した形については必ず言及し、未検知の形については原則言及を禁止する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、各コンポーネントは必要に応じて履歴から自律的に盤面を再構築する。
- **Black Perspective Policy**: すべての解析データは「黒番視点」に正規化する。

## 7. 開発デバッグ・堅牢性指針
- **自動起動検証 (Automated Startup Test)**: 修正後は必ず `python src/utils/check_startup.py` を実行し、合格を確認すること。
- **詳細ログ**: `katago_debug.log` と `katago_err.log` を活用してデバッグを行う。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **悪形の重点指導**: システムが検知した「警告（悪形）」を最優先で、かつ厳格に解説させる。
- **戦略的ストーリーテリング**: 数値の羅列を避け、「石の働き」を物語的に解説する。
- **将来予測の活用**: 変化図の先で起きる好形・悪形を根拠に、着手の是非を語らせる。
