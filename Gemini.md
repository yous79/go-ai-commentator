# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 32.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: いかなる状況下でもモデル名称を誤認、あるいは旧世代名と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。
- **ペルソナの統合**: AIアシスタントは「囲碁ドクター」としての人格を持ち、論理性・効率性・再現性を重視した指導を行う。
- **学術的根拠の重視**: 囲碁AI解説に関する先行研究や論文の知見（手順、推移、緊急度）を取り入れ、科学的に裏付けられたシステムを構築する。

## 2. 形状検知ロジック：宣言的・幾何学的厳密性 (Logic Rigor)
形状検知は、ハードコードされたロジックから、JSONによる**宣言的パターン定義**へと移行した。

### 2.1 汎用パターン照合エンジン
- **幾何学的一致**: 定義されたパターン（相対座標と石の状態）に対し、8方向（回転4×反転2）の幾何学的変換を自動適用し、網羅的に照合する。
- **状態定義**: `self`（自分）, `opponent`（相手）, `empty`（空点）, `last`（最新手）を厳密に区別する。

### 2.2 二目の頭 (Nimoku no Atama) の最終定義
- **構造的条件**: 並走する攻撃側（自分）の石の助けを得て、防御側（相手）の「厳密に2つ」並んだ石の頭を叩くこと。
- **三目以上の除外**: 連結が3つ以上（三目の頭以上）の場合は、石の強度が異なるため検知対象から除外する。
- **先制の原則**: 叩いた石（最新手）の反対側が「空点」であることを必須条件とし、混戦と区別する。

### 2.3 サカレ形 (Sakare Gata) の完全分断証明
サカレ形の検知条件を「連絡の権利」の喪失という観点から厳密化した。
- **物理的遮断の完了**: 自分の2石（一間トビ、またはケイマ）の間の最短連絡経路となる**全ての共通近傍交点**が、相手の石で埋め尽くされていること。
- **ワリコミの除外**: 相手の石が1石のみの状態は、まだ連絡の余地があるため「ワリコミ」として区別し、除外する。

## 3. 高度な盤面解析エンジン (Advanced Analysis)
先行研究に基づき、盤面の「静的・動的」な状態を多角的に定量化する。

### 3.1 石の安定度分析 (Stability Score)
- **定義**: Ownership 値を正規化した 0.0（死に体）〜 1.0（確定石）の数値。
- **ステータス**: Critical / Weak / Stable / Strong で判定。

### 3.2 着手の緊急度解析 (Urgency / Temperature) [NEW]
- **定義**: 最善手を打った時と、パスをして相手に連打された時のスコア差。
- **未来の悪形検知**: 放置した場合の「未来の盤面」において発生する悪形（サカレ形等）を自動検知し、Gemini へ警告事実として提供する。
- **緊急参考図の生成**: 被害手順を可視化した「被害予測図」を動的に生成し、ユーザーに提示する。

## 4. 構造化知識ベースと可視化 (Structured Knowledge & Visualization)
- **メタデータ (metadata.json)**: 重要度、関連項目、タグを付与。
- **論文ナレッジ (knowledge/00_papers/)**: 先行研究のエッセンスを蓄積し、システム設計に活用。
- **用語ビジュアライザー (TermVisualizer)**: 用語IDや着手手順から、論理的に正しい画像を動的に生成。

## 5. アーキテクチャと信頼性 (Infrastructure)
- **MVCパターンの遵守**: 表示、制御、通信の完全分離。
- **サーキット・ブレーカー**: APIサーバー障害時に通信を自動遮断。
- **統合構造化ロギング**: 全ての動作をレイヤー別に `system.log` へ出力。

## 6. AI解説生成：事実先行・人格統合プロトコル
- **確定事実の優先**: 解析データ、形状検知結果（現在および未来）、安定度分析、緊急度データをプロンプト最上部に配置。
- **人格の参照**: Gemini は `Gemini_Persona.md` を常に参照し、論理的・効率的な指導スタイルを厳守する。

(以下、第7条以降は Rev 31.0 と同様)
