# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 48.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改訂不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **追記の禁止**: 上記以外のモデル名（API名、特定バージョン名、他世代名等）を仕様書、ソースコード内のコメント、およびAI解説文に追記、あるいは併記することは一切禁止する。
3.  **実行プロセスにおける絶対遵守事項 (0.4)**:
    - **承認の必須性**: 実装、リファクタリング、ファイル操作等の「盤面やコードへの変更」を伴う作業に着手する際は、案を提示した後、**必ずユーザーからの明示的な承認を得ること。**
    - **独断実行の禁止**: 「進めてよいか」の確認と同時に実装（ツール呼び出し）を開始することは厳禁。必ずターンを分けてユーザーの返答を待つこと。
4.  **自律的開発プロトコル (0.5)**:
    - **ブランチの原則**: 新機能の実装時は必ず `feat/` ブランチを新規作成して作業を行う。
    - **自律的進行**: フィーチャーブランチ内においては、実装から `--verify` による自動検証まで、エラーが発生しない限り自律的にツールを連続実行し、一括して作業を進める。
    - **完了報告**: 自動検証合格後、ユーザーに結果を報告し、マージおよびプッシュの承認を求める。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **戦略と計算の融合**: Gemini の高度な推論力と KataGo の精密な計算を統合し、人間が納得できる「意味のある解説」を提供する。
- **囲碁ドクターペルソナ**: 論理性・効率性・再現性を重視した「ドクター」として、単なる強さではなく「効率」に基づいた指導を行う。
- **学術的根拠の重要性**: 論文レベルの知見（手順情報を用いた用語付与、勝率推移の言語化等）をロジックの根底に置く。

## 2. 形状検知ロジック：幾何学的汎用エンジン
### 2.1 汎用パターンエンジン
- **手順非依存検知**: アキ三角等の形状において、構成する石のどれを最後に打っても検知可能とするため、パターン定義内で複数の `last` 候補を許容する。
- **幾何学的網羅性**: 8方向の回転・反転を自動生成し、盤面サイズに同期した境界チェックを行う。

### 2.2 主要形状の定義
- **アキ三角**: 2x2内の3石+角の空点。効率の悪さを最優先で警告する。
- **サカレ形**: 連絡が物理的・論理的に遮断された状態。8近傍BFS探索による経路判定を行う。
- **二目の頭**: 2連の頭を叩かれた形。幾何学的な「叩き」を厳密に定義。

## 3. 高度な局面解析と戦略ツール
### 3.1 石の安定度分析 (Stability Score)
Ownershipデータを5段階（Dead / Critical / Weak / Stable / Strong）でラベル付けし、死に石への手入れや救済の無意味さを指摘する。

### 3.2 終盤認識ロジック (Endgame Recognition)
Ownershipデータから地の確定率を算出し、85%以上（閾値0.9）で「終盤」と判定。この情報を各解析ツールのレスポンスに含めることで、AIの戦略的トーン（ヨセへの集中）を自動調整させる。

### 3.3 戦略的シミュレーション
- **What-if 解析**: 特定の座標に石を置いたと仮定した際の将来の勝率・スコア変化を動的にシミュレーションする。
- **シナリオ比較 (Scenario Comparison)**: 推奨進行と失敗進行（放置図など）を並列に提示し、戦略的な「差」を可視化する。

### 3.4 緊急度解析 (Temperature)
最善手とパス時の損失差に基づき、局面の「熱量」を算出し、AIの警告トーンを制御する。

## 4. データ整合性と履歴管理
- **線形履歴の強制 (Linear Truncation)**: 検討モードにおいて、過去の手順を上書きして着手した場合、後続の履歴を自動的に破棄し、常に一貫した単一の手順を維持する。
- **DTOの徹底**: 解析データは `AnalysisResult` 等のオブジェクトとして管理し、生の辞書による型不明瞭を排除する。

## 5. インフラストラクチャ
- **モジュール化MCPサーバ**: MCPサーバを `System`, `Knowledge`, `Analysis` の3つの特化クラスに分割し、責務を明確化。
- **コンテキスト・オフローディング (Context Offloading)**: MCPサーバ側で対局状態を保持する `SessionManager` を導入。クライアントは `sync_session` ツールで文脈をオフロードし、以降の解析リクエストでは履歴（history）の送信を省略して通信効率を最大化する。
- **GeminiModel 抽象化層**: OpenRouter 経由の呼び出しや並列実行 (`call_parallel`)、リトライ、指数バックオフを標準実装。
- **Atomic Storage**: 全てのJSON保存は「一時ファイル保存 → リネーム」の原子的な操作で行い、ファイル破損を防止する。

## 6. AI解説プロトコル：事実先行 (Fact-First)
- **推論の構造化**: AIはトリアージされた「構造化された事実 (InferenceFact)」を元に解説文を構築する。
- **最新手の優先評価 (Last Move Evaluation)**: 解説の冒頭で、直前の着手（最新手）の是非（効率、働き、悪形の有無）を論理的に評価することを義務付ける。`InferenceFact` の `is_last_move` フラグを用いて最新手による事実を分離抽出する。
- **ハルシネーションの物理的排除**: AIが数値を捏造できないよう、解説文に含まれるべき主要数値を事前にシステム側で確定させ、プロンプトに注入する。

## 7. UI/UX アーキテクチャ
- **イベント駆動 (Event-Driven)**: `EventBus` による完全な疎結合。Viewは `STATE_UPDATED` 等のイベントを購読して自律的に更新される。
- **ナビゲーションの高度化**: 
    - 左右キーによる Undo/Redo の完全サポート。
    - **Redoバッファ**: 左キーで戻した石を右キーで復元可能。新着手時にのみクリアされる。
    - `bind_all` によるグローバルなキー操作の捕捉。

## 8. 検証・品質保証
- **二重検証義務**: 
    1. `python src/utils/check_startup.py` による起動・通信テスト。
    2. `python tests/unit/run_all_logic_tests.py` による論理整合性テスト。
- **構文チェック**: 修正後は必ず `python -m py_compile` による文法確認を行う。

## 9. ハルシネーション対策と数値監査
- **正直な拒否**: 根拠のない情報提供を求められた場合、「解析不可」と正直に答えることを最優先する。
- **数値監査**: 生成された解説文内の数値を事実データと照合し、不一致がある場合は警告または自動補正を行う。