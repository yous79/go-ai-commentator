# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 6.0

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。

## 2. アーキテクチャ定義 (Modular MVC)
システムは責務ごとに完全に分離されたディレクトリ構造を採用する。

- `src/core/`: 不変の囲碁ロジック（GameState, 座標変換）。独自メモリ管理による表示・データの完全同期。
- `src/services/`: 複合業務フロー。`AnalysisManager`（エンジン制御）、`GeminiCommentator`（AI対話）。
- `src/gui/`: 部品化されたUIコンポーネント（BoardView, InfoView）。
- `src/prompts/`: AI指示文のテンプレート管理。
- `src/drivers/`: KataGoプロセスとの低レイヤー通信。

## 3. シングルトン・エンジン・プロトコル
PCリソースの競合を防ぎ、通信の安定性を担保するため、1つのKataGoプロセスをアプリ全体で共有する。

- **優先制御 (Priority Locking)**: Agent解析（ユーザー操作）を最優先とする。
- **譲歩ロジック**: バックグラウンド解析はAgent解析の要求を検知した瞬間、即座に処理権を譲る（Yield）。
- **デッドロック防止**: 最大60秒のロック待ちと、異常検知時のプロセス自動再起動。

## 4. AI解説生成：手動3段階プロトコル (Standard)
ハルシネーションと無限ループを物理的に封殺するための厳格な手順。

1.  **Step 1 (Force)**: `mode='ANY'` でツール要求のみを強制。テキストが混入したレスポンスは即座に破棄。
2.  **Step 2 (Execution)**: プログラムがKataGoを実行。データ不備があればGeminiにマイクを渡さず終了。
3.  **Step 3 (Explanation)**: **Context Reset**を実施。過去の履歴を捨て、最新の事実データ（勝率・座標）のみを注入して解説を生成。
4.  **Hard Guard**: 生成文に「勝率(%)」と「推奨座標」が含まれない場合は捏造と断じ、表示をブロックする。

## 5. 知識ベースの活用規約
- **受動的参照**: 知識ベースの用語は、局面やPVに実際に現れている場合のみ言及する。
- **例題ルール**: 知識ベース内の座標（E6等）は「サンプル」であり、回答への混入を厳禁とする。
- **着手番号の義務化**: 用語を指摘する際は、履歴内の具体的な着手番号（例：黒#15）との紐付けを必須とする。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **Black Perspective Policy**: 全てのレイヤー（保存、計算、表示、AI入力）において、勝率と目数は **「常に黒番視点」** で統一する。
- 手番による反転処理は、データの生成・保存の瞬間にのみ行い、GUI層やAI Engine層では一切の計算・反転を行わない。

## 7. 開発デバッグ指針
- **UTF-8徹底**: Windows環境での日本語パス・プロセス通信における文字化けを防止。
- **非同期UI**: ThreadPoolExecutor を活用し、解析中もUIの応答性を維持する。
- **生存確認ログ**: 各レイヤーに `DEBUG` ログを配置し、データの到達を可視化する。