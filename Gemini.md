# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 28.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: いかなる状況下でもモデル名称を誤認、あるいは旧世代名と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。
- **ペルソナの統合**: AIアシスタントは「囲碁ドクター」としての人格を持ち、論理性・効率性・再現性を重視した指導を行う。

## 2. 形状検知ロジック：宣言的・幾何学的厳密性 (Logic Rigor)
形状検知は、ハードコードされたロジックから、JSONによる**宣言的パターン定義**へと移行した。

### 2.1 汎用パターン照合エンジン
- **幾何学的一致**: 定義されたパターン（相対座標と石の状態）に対し、8方向（回転4×反転2）の幾何学的変換を自動適用し、網羅的に照合する。
- **状態定義**: `self`（自分）, `opponent`（相手）, `empty`（空点）, `last`（最新手）を厳密に区別する。

### 2.2 二目の頭 (Nimoku no Atama) の最終定義
- **構造的条件**: 並走する攻撃側（自分）の石の助けを得て、防御側（相手）の「厳密に2つ」並んだ石の頭を叩くこと。
- **三目以上の除外**: 連結が3つ以上（三目の頭以上）の場合は、石の強度が異なるため検知対象から除外する。
- **先制の原則**: 叩いた石（最新手）の反対側が「空点」であることを必須条件とし、混戦と区別する。

### 2.3 サカレ形 (Sakare Gata) の完全分断証明
サカレ形の検知条件を「連絡の権利」の喪失という観点から厳密化した。
- **物理的遮断の完了**: 自分の2石（一間トビ、またはケイマ）の間の最短連絡経路となる**全ての共通近傍交点**が、相手の石で埋め尽くされていること。
- **ワリコミの除外**: 相手の石が1石のみの状態は、まだ連絡の余地があるため「ワリコミ」として区別し、除外する。

## 3. 石の安定度分析 (Stone Stability Analysis)
KataGo の `ownership` データを活用し、盤上の石の生存確率を論理的に抽出する。
- **安定度スコアリング**: 0.0（死に体）〜 1.0（確定石）の数値でグループの状態を判定。
- **ステータス**: Critical / Weak / Stable / Strong の4段階でGeminiへ通知。

## 4. 構造化知識ベースと可視化 (Structured Knowledge & Visualization)
知識ベースは、メタデータに加えて「正確なお手本」を提供する能力を備えた。
- **メタデータ (metadata.json)**: 各用語に `importance`, `related_terms`, `tags` を付与。
- **用語ビジュアライザー (TermVisualizer)**: 
    - 用語IDから、論理的に正しい盤面画像を動的に生成。
    - **論理バリデーション**: 生成された画像が実際にその形状を含んでいるかを `ShapeDetector` で自動検証する。

## 5. アーキテクチャと信頼性 (Infrastructure)
- **MVCパターンの遵守**: 表示 (View)、制御 (Controller)、通信 (APIClient) を分離。
- **サーキット・ブレーカー**: APIサーバー障害時に通信を自動遮断し、システムフリーズを防止する。
- **統合構造化ロギング**: 全ての動作をレイヤー別に `system.log` へ出力。

## 6. AI解説生成：事実先行・人格統合プロトコル (Fact-First & Persona Integration) [UPDATED]
- **確定事実の優先**: 解析データ、形状検知結果、安定度分析をプロンプト最上部に配置。
- **人格の参照**: Gemini は解説生成にあたり、プロジェクト内の **`Gemini_Persona.md`** を常に参照する。
- **医学用語の排除**: 読者の理解を優先するため、直接的な医学用語（診断、処方、リハビリ等）の乱用を厳禁とし、囲碁の言葉による論理的・効率的なスタイルを維持する。

## 7. 開発デバッグ・堅牢性指針 (Verification Standards)
- **二重検証義務**: コード変更後は必ず以下を実行し、合格を確認すること。
    1. `python src/utils/check_startup.py` (インフラ確認)
    2. `python tests/unit/run_all_logic_tests.py` (厳密論理テスト環境)

## 8. 復旧プロトコル (Recovery Protocol) - [改定不可]
(Rev 21.0 と同様)

## 9. 開発プロセス：提案・承認プロトコル (Proposal-First Protocol) - [改定不可]
(Rev 21.0 と同様)

## 10. 開発優先方針 (Development Priority Policy)
- **機能・論理の最優先**: 盤面解析、形状検知、安定度分析、AI解説の質を最優先する。
- **ビジュアル面の後回し**: UIの装飾等は、コア機能の安定後に実施する。

## 11. 外部人格定義の管理 (External Persona Management)
- **分離の原則**: システムの動作仕様は `Gemini.md` で、AIの性格や執筆スタイルは `Gemini_Persona.md` で個別に管理する。
- **プロンプトへの注入**: 必要に応じて `Gemini_Persona.md` の内容をシステムインストラクションとして自動的に注入する。
