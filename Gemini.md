# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 42.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改訂不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: いかなる状況下でもモデル名称を誤認、あるいは旧世代名と混同してはならない。
3.  **実行プロセスにおける絶対遵守事項 (0.4)**:
    - **承認の必須性**: 実装、リファクタリング、ファイル操作等の「盤面やコードへの変更」を伴う作業に着手する際は、案を提示した後、**必ずユーザーからの明示的な承認を得ること。**
    - **独断実行の禁止**: 「進めてよいか」の確認と同時に実装（ツール呼び出し）を開始することは厳禁。必ずターンを分けてユーザーの返答を待つこと。
4.  **開発・検証プロセス (0.5)**:
    - **自動検証モード**: `--verify` フラグによる主要機能（ロード、解析、解説生成）の一括自動テストを標準とする。
    - **高速検証 (Fast-Check)**: 検証モードにおいては、目標が達成された時点で即座にプロセスを終了し、開発サイクルを高速化する。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、初級者が論理的に「納得できる」対話型解説体験を提供する。
- **ペルソナの統合**: AIアシスタントは「囲碁ドクター」としての人格を持ち、論理性・効率性・再現性を重視した指導を行う。
- **学術的根拠の重要性**: 囲碁AI解説に関する先行研究や論文の知見（手順情報、勝率推移、着手価値等）を取り入れ、科学的に裏付けられたシステムを構築する。

## 2. 形状検知ロジック：動的・幾何学的・効率性ハイブリッド (Logic Rigor)
形状検知は、静的なパターン照合と、着手の手順を考慮した動的解析のハイブリッド構成とする。

### 2.1 汎用パターンエンジン
- **幾何学的網羅性**: 定義されたパターンに対し、8方向（回転4×反転2）の幾何学的変換を自動適用し、網羅的に照合する。
- **状態定義**: `self`（自分の石）, `opponent`（相手の石）, `empty`（空点）, `last`（最新手候補）を厳密に区別する。
- **動的サイズ同期**: 盤面サイズ（9, 13, 19）に応じて境界チェックを自動調整する。

### 2.2 主要形状の厳密定義
- **アキ三角 (Aki Sankaku)**: 2x2の範囲内に3つの石があり、角が空点である形。手順に依存せず、構成する3石のどこを最後に打っても検知されるよう、全石を `last` 候補として定義する。
- **二目の頭 (Nimoku no Atama)**: 並走する攻撃側の石の助けを得て、防御側の「厳密に2つ」並んだ石の頭を叩くこと。3つ以上の連の場合は対象外とする。
- **サカレ形 (Sakare Gata)**: 自分の連絡が物理的（8近傍探索）に遮断された効率の悪い形。

### 2.3 効率性・干渉解析 (Efficiency Analysis)
- **カス石干渉 (Kasu-ishi Interference)**: 相手の既に死んでいる石（Ownership > 0.8の領域内）に対して不要な手入れを行うことを「手数の浪費」として検知する。

## 3. 高度な局面解析エンジン (Advanced Analysis)
KataGo の計算結果を多角的に定量化し、AI解説の優先度とトーンを制御する。

### 3.1 石の安定度分析 (Stability Score)
Ownershipデータを以下の5段階でラベル付けし、AI解説の優先度を制御する。
1. **Dead (死に/カス石)**: Stability < 0.0 (救出不可。AIは救済を勧めない)
2. **Critical (死に体)**: Stability 0.0 - 0.2 (非常に危険。補強が急務)
3. **Weak (弱い)**: Stability 0.2 - 0.5 (攻防の焦点)
4. **Stable (安定)**: Stability 0.5 - 0.8 (ほぼ安全)
5. **Strong (確定)**: Stability > 0.8 (完全に生き)

### 3.2 着手の緊急度解析 (Urgency / Temperature)
- **定義**: 最善手を打った時と、パスをして相手に連打された時のスコア差。
- **デュアル・ポップアップ**: 緊急局面において「推奨進行（成功図）」と「放置被害（失敗図）」の両方を自動生成し、同時に提示する。

## 4. 解析データ・パイプライン
- **DTO (Data Transfer Object)**: 解析データは生の辞書ではなく `AnalysisResult` オブジェクトを介して受け渡し、型安全性を保証する。
- **Single Source of Truth**: 盤面状態の正解は常に「着手履歴」にあり、履歴から動的に盤面を再構築する。

## 5. インフラと信頼性 (Infrastructure)
- **MVCパターンの徹底**: View, Controller, Orchestrator, APIの疎結合を維持。
- **サーキットブレーカー**: 通信障害時の自動遮断と、ユーザーへの「解析不可」の正直な報告。
- **Atomic Storage**: 設定や解析結果の保存は一時ファイル経由で行い、データ破損を防止する。

## 6. AI解説生成：事実先行・人格統合プロトコル (Fact-First)
- **事実の構造化 (InferenceFact)**: AIは自らツールを呼ぶのではなく、提供された「構造化された事実」の言語化（意味付け）に集中する。
- **トリアージ**: 膨大な解析データから、重要度（Severity）の高い事実のみを抽出してプロンプトに注入する。

## 7. UI/UX アーキテクチャ
- **イベント駆動 (Event-Driven)**: `EventBus` を介した疎結合通信。直接のメソッド呼び出しを禁止する。
- **自律的更新 (Autonomous Update)**: 各Viewは必要なイベントを購読し、表示を最新に保つ。
- **検討モードの操作性**: 
    - 左右キーによる手順の前後移動をサポート。
    - **Redoバッファ**: 左キーで戻した検討用の石を、右キーで復元できる。新しく石を置いた場合はクリアされる。

## 8. 検証基準 (Verification Standards)
- **二重検証義務**: コード変更後は必ず以下を実行し、合格を確認すること。
    1. `python src/utils/check_startup.py` (インフラ・起動確認)
    2. `python tests/unit/run_all_logic_tests.py` (厳密論理テスト)

## 9. ハルシネーション対策 (Anti-Hallucination)
- **能力の限界の自己申告**: 技術的に不可能な事項（動画の直接理解など）を捏造しない。
- **正直な「できない」の回答**: 根拠のない情報提供を求められた場合、正直に回答を拒否することを最優先する。
- **数値の監査**: 解説文に含まれる勝率や目数などの数値が、事実データと一致するかをシステム側で照合する。
