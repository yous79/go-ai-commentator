# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 25.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: いかなる状況下でもモデル名称を誤認、あるいは旧世代名と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

## 2. 形状検知ロジック：宣言的・幾何学的厳密性 (Logic Rigor)
形状検知は、ハードコードされたロジックから、JSONによる**宣言的パターン定義**へと移行した。

### 2.1 汎用パターン照合エンジン
- **幾何学的一致**: 定義されたパターン（相対座標と石の状態）に対し、8方向（回転4×反転2）の幾何学的変換を自動適用し、網羅的に照合する。
- **状態定義**: `self`（自分）, `opponent`（相手）, `empty`（空点）, `last`（最新手）を厳密に区別する。

### 2.2 二目の頭 (Nimoku no Atama) の最終定義
- **構造的条件**: 並走する攻撃側（自分）の石の助けを得て、防御側（相手）の「厳密に2つ」並んだ石の頭を叩くこと。
- **三目以上の除外**: 連結が3つ以上（三目の頭以上）の場合は、石の強度が異なるため検知対象から除外する。
- **先制の原則**: 叩いた石（最新手）の反対側が「空点」であることを必須条件とし、混戦と区別する。

## 3. 石の安定度分析 (Stone Stability Analysis) [NEW]
KataGo の `ownership` データを活用し、盤上の石の生存確率を論理的に抽出する。

### 3.1 安定度スコアリング (Stability Score)
- **定義**: 各石の座標における Ownership 値（黒: 1.0, 白: -1.0 が最大値）を、その石の色の視点で正規化した値（0.0 〜 1.0）。
- **グループ分析**: 隣接する同色の石をグループ化し、グループ全体の平均安定度を算出する。
- **ステータス判定**:
    - **Critical (< 0.2)**: 死に体、または極めて危険な状態。
    - **Weak (< 0.5)**: 弱い石。相手からの攻撃対象。
    - **Stable (>= 0.5)**: 安定。
    - **Strong (>= 0.8)**: 確定地に近い、極めて強固な石。

## 4. 構造化知識ベース (Structured Knowledge)
知識ベースは、単なるテキストから「メタデータ付きリソース」へと進化した。
- **メタデータ (metadata.json)**: 各用語に `importance`, `related_terms`, `tags` を付与。
- **動的抽出プロトコル**: 検知された形状IDに基づき、関連知識を優先度順に抽出する。

## 5. アーキテクチャと信頼性 (Infrastructure)
- **MVCパターンの遵守**: 表示 (View)、制御 (Controller)、通信 (APIClient) を分離。
- **サーキット・ブレーカー**: APIサーバー障害時に通信を自動遮断し、システムフリーズを防止する。
- **統合構造化ロギング**: レイヤー別に `system.log` へ出力。

## 6. AI解説生成：事実先行プロトコル (Fact-First Protocol)
- **確定事実の優先**: 解析データ、形状検知結果に加え、**「石の安定度分析」**をプロンプト最上部に配置。
- **論理的根拠**: Gemini は「なぜその手が重要か」を、石の強弱（安定度）という客観的数値に基づいて言語化する。

## 7. 開発デバッグ・堅牢性指針 (Verification Standards)
- **二重検証義務**: コード変更後は必ず以下を実行し、合格を確認すること。
    1. `python src/utils/check_startup.py` (インフラ確認)
    2. `python tests/unit/run_all_logic_tests.py` (厳密論理テスト環境)

## 8. 復旧プロトコル (Recovery Protocol) - [改定不可]
(省略：Rev 21.0 と同様)

## 9. 開発プロセス：提案・承認プロトコル (Proposal-First Protocol) - [改定不可]
(省略：Rev 21.0 と同様)

## 10. 開発優先方針 (Development Priority Policy)
- **機能・論理の最優先**: 盤面解析、形状検知、安定度分析、AI解説の質を最優先する。
- **ビジュアル面の後回し**: UIの装飾等は、コア機能の安定後に実施する。