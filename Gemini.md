# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 17.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: エージェントはいかなる状況下でもモデル名称を誤認、あるいは旧世代名（Gemini 1.5/2.0等）と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

## 2. アーキテクチャ定義 (Intelligence Hub & Reliability)
システムは、常駐APIを中心に、非同期ワーカーと動的UIが協調するハブ構造を採用する。
- **`src/utils/verify_sgf_flow.py` (Reliability Guard)**: SGFの処理から解析、GUI表示直前までのデータ整合性を保証する標準テストスイート。

## 3. エンジン・マネジメント・プロトコル
- **プロセスの完全分離**: すべての解析は `localhost:8000` (katago_api) を唯一の窓口とし、リソースの奪い合いを防止する。
- **リソース競合の解決**: APIサーバー側でリトライロジックを備え、複数クライアントからの要求を安全に処理する。

## 4. AI解説生成：事実先行プロトコル (Fact-First Protocol)
1.  **先行解析 (Pre-Analysis)**: ユーザーの要求に対し、プログラムが自律的に解析ツールを実行し、勝率、目数、形状予測、幾何学的形状等の確定事実を取得する。
2.  **事実の文脈注入 (Fact Injection)**: 取得したデータをプロンプトの最上部に配置。**Gemini 3 Flash Preview** に対し「数字を予想・捏造する」動機を物理的に排除する。
3.  **純粋な解釈フェーズ**: AIは提供された正確なデータをどう級位者に納得させるかという、戦略的言語化（意味付け）に集中する。

## 5. 知識ベースの活用・検知規約
- **階層化管理**: 知識を「悪形・失着（重要）」と「一般手筋（一般）」に分類。
- **ハイブリッド検知**: `ShapeDetector` が抽出した事実に対し、AIがその理由を知識ベースを引用して解説する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、必要に応じて動的に復元する。
- **Partial Data Resilience**: 並列解析中はデータが不完全な（穴あき）状態であることを前提とし、各コンポーネントは `None` 値を安全にスキップまたは補完しなければならない。

## 7. 開発デバッグ・堅牢性指針 (Verification Standards)
- **非同期例外の可視化**: すべてのバックグラウンドタスクは `traceback.print_exc()` による例外出力を行い、「沈黙するエラー」を徹底排除する。
- **二重検証義務**: コード変更後は必ず以下を実行し、合格を確認すること。
    1. `python src/utils/check_startup.py` (プロセスの起動確認)
    2. `python src/utils/verify_sgf_flow.py` (解析データの整合性確認)
- **捏造防止ガード (Hallucination Audit)**: 生成された解説文内の数値が、事実データと一致するかを自動照合する。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **視覚的コンテキストの統合**: 勝率グラフ上の変化点（急落・急騰）をクリックすることで、その瞬間の事実と紐付けた深い検討を可能にする。
- **表現の具体化**: 「重い・軽い」を禁止し、「強い石（安定）」「弱い石（不安定）」という用語を使用する。
- **将来予測の活用**: **Gemini 3 Flash Preview** の高度な推論能力を活かし、変化図の先で起きる事実を根拠に、着手の是非を論理的に語らせる。
