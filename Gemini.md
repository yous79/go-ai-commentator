# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 5.0

## 1. ビジョン (Vision)
KataGoによる正確な計算（読み）と、Gemini 3による高度な推論・言語能力（知性）を融合させ、大人の級位者が論理的に納得できる「囲碁の対話型解説体験」を提供する。

## 2. アーキテクチャ定義 (Modular Architecture)
本システムはMVCおよびサービス層をベースとしたモジュール構造を採用している。

### 2.1 ディレクトリ責務
- `src/core/`: 不変の囲碁ロジック（GameState, 座標変換）。
- `src/services/`: 複雑な業務フロー（AI対話制御、レポート生成、解析管理）。
- `src/gui/`: ユーザーインターフェース（部品化されたViewとController）。
- `src/drivers/`: 外部実行ファイル（KataGo）との低レイヤー通信。
- `src/utils/`: 共通ユーティリティ（画像描画、定数、ヘルパー）。
- `src/prompts/`: AIへの指示文（テンプレート化された指示定義）。

### 2.2 依存関係の原則
- **単方向依存**: GUIはサービスを利用するが、サービスはGUIの実装を知ってはならない。
- **設定の集約**: パスや定数の直接記述を禁止し、常に `src/config.py` を経由すること。

## 3. AI解説生成プロトコル (Manual 3-Step Execution)
ハルシネーションと無限ループを物理的に封殺するため、以下の「手動3段階実行」を厳守する。

1.  **Step 1: 強制呼び出し (Force Phase)**
    - `mode='ANY'` を使用し、且つ `tools` には関数オブジェクトではなく**手動定義したスキーマ (types.Tool)** を渡す。
    - これによりSDKの自動実行を阻止し、確実に `FunctionCall` をプログラム側で受け取る。
2.  **Step 2: 手動実行 (Execution Phase)**
    - Python側でツール（`consult_katago_tool`）を**1回だけ**実行し、結果を取得する。
3.  **Step 3: 解説生成 (Generation Phase)**
    - 取得したデータを履歴に含め、`tools=[]` および `mode='NONE'` 設定で再度リクエスト。
    - **文脈の上書き**: Step 3ではシステム指示を「データ取得済み」の前提に差し替え、以前の「盤面が見えない」というプロンプトを無視させる。

## 4. プロンプト・エンジニアリング規約
- **Blindness Strategy**: Step 1ではAIに「盤面が全く見えていない」と定義し、ツール使用を論理的に不可避にする。
- **Passive Reference Rule**: 知識ベース（サカレ形等）の用語は、**盤面や変化図(PV)に実際にその形が現れている場合のみ**言及する。無理な当てはめは厳禁。
- **履歴の最適化**: トークン節約と速度向上のため、Geminiへのテキスト履歴は直近50手に制限する（解析には全履歴を使用）。

## 5. 囲碁データ整合性ルール
- **勝率の標準化**: 内部・外部を問わず、勝率は常に「黒番視点 (0.0～1.0)」で統一する。手番が白の場合は `1.0 - winrate` を行う。
- **悪手判定 (Mistake Ranking)**: 
    - リストアップは「勝率の下落幅」を主軸にソートする。
    - UIには必ず「目数差の下落幅」も併記し、情報の多角化を図る。

## 6. 開発Anti-Bugマニフェスト
- **文字コード**: Windows環境対策として、`subprocess` 通信およびファイル入出力には `encoding='utf-8'` を徹底する。
- **非同期処理**: API通信や解析待ちなどの重い処理は `ThreadPoolExecutor` 等を用い、UIスレッドをブロックしない。
- **解析スキップ**: 既に `analysis.json` が存在する対局は、再解析をスキップして高速化を図る。