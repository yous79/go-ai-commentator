# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 24.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: いかなる状況下でもモデル名称を誤認、あるいは旧世代名と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

## 2. 形状検知ロジック：宣言的・幾何学的厳密性 (Logic Rigor) [NEW]
形状検知は、ハードコードされたロジックから、JSONによる**宣言的パターン定義**へと移行した。

### 2.1 汎用パターン照合エンジン
- **幾何学的一致**: 定義されたパターン（相対座標と石の状態）に対し、8方向（回転4×反転2）の幾何学的変換を自動適用し、網羅的に照合する。
- **状態定義**: `self`（自分）, `opponent`（相手）, `empty`（空点）, `last`（最新手）を厳密に区別する。

### 2.2 二目の頭 (Nimoku no Atama) の最終定義
- **構造的条件**: 並走する攻撃側（自分）の石の助けを得て、防御側（相手）の「厳密に2つ」並んだ石の頭を叩くこと。
- **三目以上の除外**: 連結が3つ以上（三目の頭以上）の場合は、石の強度が異なるため検知対象から除外する。
- **先制の原則**: 叩いた石（最新手）の反対側が「空点」であることを必須条件とし、混戦と区別する。

### 2.3 サカレ形 (Sakare Gata) の分断証明
- **8近傍BFSによる断絶**: 自分の2石（一間トビ・ケイマ）の間に相手が割り込み、かつ8近傍探索によって「物理的な連絡経路が完全に絶たれている」ことが証明された場合のみ検知する。

## 3. 構造化知識ベース (Structured Knowledge) [NEW]
知識ベースは、単なるテキストから「メタデータ付きリソース」へと進化した。

- **メタデータ (metadata.json)**: 各用語に `importance`（重要度）, `related_terms`（関連項目）, `tags`（検索タグ）を付与。
- **動的抽出プロトコル**: 検知された形状のIDに基づき、メタデータから関連知識を優先度順に抽出し、AIのコンテキスト窓を最適化する。

## 4. アーキテクチャと信頼性 (Infrastructure)
- **MVCパターンの遵守**: 表示 (View: app.py)、制御 (Controller: controller.py)、通信 (APIClient: api_client.py) を分離して管理する。
- **ハイブリッド検知**: JSON定義による `GenericPatternDetector` と、複雑な動的解析を要するレガシー Detector が共存するプラグイン方式。
- **自律的ライフサイクル管理**: 起動時に古いプロセスを自動クリーンアップし、APIサーバーを自律起動する。
- **統合構造化ロギング**: 全ての動作をレイヤー別に `system.log` およびコンソールに出力する。

## 5. AI解説生成：事実先行プロトコル (Fact-First Protocol)
- 確定事実（解析データ・形状検知結果・構造化メタデータ）をプロンプト最上部に配置。**Gemini 3 Flash Preview** は、提供された正確なデータに基づく戦略的言語化に集中する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、不完全なデータ（None値）や画像読み込みエラーを安全に処理する。

## 7. 開発デバッグ・堅牢性指針 (Verification Standards)
- **二重検証義務**: コード変更後は必ず以下を実行し、合格を確認すること。
    1. `python src/utils/check_startup.py` (インフラ確認)
    2. `python tests/unit/test_shapes.py` (形状検知論理確認)

## 8. 解説品質向上への注力事項
- 視覚的コンテキストの統合、および将来予測に基づく論理的解説の強化。

## 9. 復旧プロトコル (Recovery Protocol) - [改定不可]
開発プロセスにおいて論理的整合性が失われたり、修復困難なエラーが発生した場合の対応指針。

1. **独断実行の禁止**: エージェントはいかなる状況下でも、**ユーザーの明示的な許可（例：「リセットしてください」等の指示）なしに** `git reset --hard` 等の破壊的コマンドを実行してはならない。
2. **復旧の提案**: 混乱やデグレードを検知した場合、エージェントはユーザーに対し「最後にプッシュされた正常な状態（origin/main）への強制復旧」を速やかに提案すること。
3. **強制リセットの手順 (許可取得後)**:
   - `git fetch origin && git reset --hard origin/main`
   - 全プロセスの強制終了: `powershell.exe -NoProfile -Command "taskkill /F /IM python.exe /T; taskkill /F /IM katago.exe /T"`
4. **正常性の再証明**: 復旧後は必ず `python tests/unit/test_shapes.py` を実行し、全テストの合格を確認すること。

## 10. 開発プロセス：提案・承認プロトコル (Proposal-First Protocol) - [改定不可]
開発の透明性を確保し、デグレードや意図しない変更を防止するための絶対手順。

1. **実装前の提案義務**: エージェントは、コードの修正、新機能の追加、ファイルの作成を行う前に、必ず具体的な「実装案」をユーザーに提示しなければならない。
2. **案に含めるべき項目**: 
   - アルゴリズムやロジックの詳細
   - 修正・作成対象となるファイルパス
   - 期待される動作と影響範囲
3. **承認の待機**: ユーザーから明示的な承認（例：「その案で進めてください」「実装をお願いします」等）を得るまで、ツールを用いた実際のファイル操作を開始してはならない。
4. **例外**: 既存ファイルの単純な読み込み（read_file）や検索（search_file_content）などの調査活動は、承認なしに実行可能である。

## 11. 開発優先方針 (Development Priority Policy) [NEW]
- **機能・論理の最優先**: 盤面解析の正確性、形状検知の論理性、AIによる解説の質といった「機能面」の実装を最優先事項とする。
- **ビジュアル面の後回し**: UIデザインの洗練、グラフの装飾、視覚的なエフェクト等の改善は、コア機能が十分に安定し、目的とする「納得感のある解説体験」が実現された後のフェーズで検討する。
- **プロトタイプとしての完結性**: 視覚的な美しさよりも、エンジニアリングとしての堅牢性と、囲碁理論に基づいた正しい事実の提示を重視する。
