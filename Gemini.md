# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 10.1

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。
3.  **解説の論理的深度の向上**: **ハイブリッド検知**（幾何学的解析＋AI推論）により、盤面の物理的状況と戦略的意味を完全に同期させる。

## 2. アーキテクチャ定義 (Modular MVC & Hybrid Agent)
システムは、プログラムによる「確定事実の抽出」と、AIによる「動的な解釈」の二段構えで構成される。

- `src/core/`: 
    - `GameState`, `CoordinateTransformer`: 基盤ロジック。
    - **`ShapeDetector`**: 盤面を走査し、アキ三角やサカレ形などの幾何学的パターンを100%の精度で検知する。
- `src/services/AICommentator`: `ShapeDetector` が抽出した事実データをプロンプトに注入し、論理構築の「前提条件」としてGeminiに与える。
- `src/gui/`: 部品化されたUIコンポーネント。ThreadPoolExecutorによる非同期管理。

## 3. シングルトン・エンジン・プロトコル
PCリソースの競合を防ぎ、通信の安定性を担保するため、1つのKataGoプロセスをアプリ全体で共有する。
- **スレッドセーフ初期化**: Double-Checked Lockingによるインスタンス管理。
- **優先制御 (Priority Locking)**: Agent解析を最優先。

## 4. AI解説生成：統合知能プロトコル (Integrated Intelligence)
1.  **事実先行 (Facts First)**: Geminiが思考を開始する前に、システムが `ShapeDetector` を用いて盤面の幾何学的特徴（悪形、分断、連絡の有無）を抽出する。
2.  **自律的検証ループ**: Geminiは提示された「事実」とKataGoの「数値」を照らし合わせ、その整合性を確認した上で解説を生成する。
3.  **文脈の永続化**: 過去の履歴を保持し、一貫性のある指導を行う。

## 5. 知識ベースの活用・検知規約
- **厳格な出現判定**:
    - `ShapeDetector` が検知した形については、解説内で**「必ず」**言及する。
    - 未検知の形については、原則として用語を用いた言及を禁止する。
- **サカレ形（裂かれ形）の厳密定義**:
    - **「割り込み」との区別**: 石の間に相手が来た（割り込み）だけではサカレ形とは呼ばない。
    - **連絡の検証**: 突き抜けられていても、後方の石との「コスミ」等で連絡が維持されている場合は、悪形としての「サカレ形」判定から除外する。
    - **検知対象**: 一間トビおよびケイマの連結が、相手の石によって「直線的に貫通」された状態のみをサカレ形と断ずる。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **Black Perspective Policy**: すべての解析データはドライバー層で「黒番視点」に完全正規化する。

## 7. 開発デバッグ・堅牢性指針
- **Atomic Storage**: JSON保存は一時ファイルへの書き込み完了後にリネームを行うことで、データ破損を防止。
- **自動起動検証 (Automated Startup Test)**: 
    - コード修正後は、必ず `python src/utils/check_startup.py` を実行すること。
    - このスクリプトはアプリを起動し、**「5秒間生存」**を確認したあと自動でプロセスを終了させる。
    - 検証がパスしない限り、タスク完了を宣言してはならない。
- **詳細ログ**: `katago_debug.log` と `katago_err.log` によるトラブルシューティング。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **幾何学的事実に基づく論理**: システムが検知した形状に対し、なぜそれがこの局面で重要なのかを論理的に言語化させる。
- **用語の正確な使い分け**: 「割り込み（着手）」と「サカレ形（状態）」を混同せず、プロの語彙で指導させる。