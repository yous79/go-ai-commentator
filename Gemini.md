# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 19.0

## 0. モデル名称・認識に関する絶対規約 (Model Identification Protocol) - [改定不可]
1.  **最新モデルの正確な認識**: 本システムが使用する最新の戦略的知性モデルは **Gemini 3 Flash Preview** である。
2.  **捏造の禁止**: いかなる状況下でもモデル名称を誤認、あるいは旧世代名（Gemini 1.5/2.0等）と混同してはならない。
3.  **記述の遵守**: 仕様書、プロンプト、解説文、およびユーザーとの対話において、常にこの正確なモデル名称を基軸として思考し、出力すること。

## 1. ビジョンと絶対目標 (Vision & Core Goals)
- **Gemini 3 Flash Preview** の戦略的知性と KataGo の精密な計算を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

## 2. 形状検知ロジックの究極的厳密性 (Logic Rigor) - [Rev 19.0 強化]
形状検知は単なるパターン照合ではなく、囲碁の本質である「先制」と「効率」の論理に従う。

### 2.1 二目の頭 (Nimoku no Atama) の決定版定義
- **先制の原則 (Priority)**: 相手に叩かれた際、反対側の急所が「空点」である場合のみ検知する。双方で叩き合っている（切り違い等）場合は、先制の利が消失しているため除外する。
- **急所の孤立性 (Isolation)**: 叩いている石の周囲8マスに、防御側（自分）の石が一切存在しないこと（二目自身を除く）。連絡や反撃がある形は「二目の頭」という純粋な急所打ちとはみなさない。
- **自軍の純粋性**: 対象となる自軍の石は、直線状に「厳密に2つ」並んでいること。

### 2.2 アキ三角 (Aki Sankaku) のシンプル定義
- 2x2の範囲内に同色の石が3つ、空点（'.'）が1つ存在する「L字型」を、意味付けを排して純粋に幾何学的形状として検知する。

## 3. 統合検知アーキテクチャ (Integrated Detection)
- **同時多角的評価**: `ShapeDetector` は、一つの局面に対して全ての検知戦略（二目の頭、アキ三角、サカレ形等）を同時に実行する。
- **検知の空白地帯の排除**: 特定の Detector が厳密化により沈黙しても、他の Detector が補完することで、盤面の「悪さ」を多角的にあぶり出す。

## 4. アーキテクチャと信頼性 (Infrastructure)
- **自律的ライフサイクル管理**: `main.py` 起動時に古いプロセス（Python/KataGo）を自動クリーンアップし、APIサーバーを自律起動する。
- **パフォーマンス最適化**: `visits=100`, `batch_size=4` の設定により、高精度な解析と高速なロードを両立させる。

## 5. AI解説生成：事実先行プロトコル (Fact-First Protocol)
1.  **先行解析 (Pre-Analysis)**: ユーザーの要求に対し、プログラムが自律的に解析ツールを実行し、勝率、目数、形状予測、幾何学的形状等の確定事実を取得する。
2.  **事実の文脈注入 (Fact Injection)**: 取得したデータをプロンプトの最上部に配置。**Gemini 3 Flash Preview** に対し「数字を予想・捏造する」動機を物理的に排除する。
3.  **純粋な解釈フェーズ**: AIは提供された正確なデータをどう級位者に納得させるかという、戦略的言語化（意味付け）に集中する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、必要に応じて動的に復元する。
- **Partial Data Resilience**: 並列解析中はデータが不完全な状態であることを前提とし、各コンポーネントは `None` 値を安全にスキップまたは補完しなければならない。

## 7. 開発デバッグ・堅牢性指針 (Verification Standards)
- **非同期例外の可視化**: すべてのバックグラウンドタスクは `traceback.print_exc()` による例外出力を行い、「沈黙するエラー」を徹底排除する。
- **統合テスターの活用**: ロジックの修正後は `src/utils/interactive_test.py` を使用し、複数の愚形が正しく検知されるかを検証する。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **視覚的コンテキストの統合**: 勝率グラフ上の変化点をクリックすることで、その瞬間の事実と紐付けた深い検討を可能にする。
- **表現の具体化**: 「重い・軽い」を禁止し、「強い石（安定）」「弱い石（不安定）」という用語を使用する。
- **将来予測の活用**: **Gemini 3 Flash Preview** の高度な推論能力を活かし、変化図の先で起きる事実を根拠に、着手の是非を論理的に語らせる。
