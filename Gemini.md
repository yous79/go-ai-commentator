# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 7.0

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。

## 2. アーキテクチャ定義 (Modular MVC & Worker)
システムは責務ごとに完全に分離され、重い処理は非同期ワーカーに委譲する構造を採用する。

- `src/core/`: 不変の囲碁ロジック（GameState, 座標変換）。独自メモリ管理による表示・データの完全同期。
- `src/services/`: 
    - `AnalysisManager`: 解析フロー制御。**Atomic Write**によるデータ保護。
    - **`ImageWriter`**: 画像生成・保存を専門に行うバックグラウンド・ワーカー。
    - `GeminiCommentator`: AI対話（AI解説生成）。**Knowledge Cache**による高速化。
- `src/gui/`: 部品化されたUIコンポーネント。**ThreadPoolExecutor**による非同期タスク管理。
- `src/prompts/`: AI指示文のテンプレート管理。
- `src/drivers/`: KataGoプロセスとの低レイヤー通信。**Double-Checked Locking**によるスレッドセーフなシングルトン。

## 3. シングルトン・エンジン・プロトコル
PCリソースの競合を防ぎ、通信の安定性を担保するため、1つのKataGoプロセスをアプリ全体で共有する。

- **スレッドセーフ初期化**: インスタンス生成時の競合を防ぎ、アプリ全体で唯一のプロセスを保証する。
- **優先制御 (Priority Locking)**: Agent解析（ユーザー操作）を最優先とする。
- **譲歩ロジック**: バックグラウンド解析はAgent解析の要求を検知した瞬間、即座に処理権を譲る（Yield）。

## 4. AI解説生成：手動3段階プロトコル (Standard)
ハルシネーションと無限ループを物理的に封殺するための厳格な手順。

1.  **Step 1 (Force)**: `mode='ANY'` でツール要求のみを強制。テキストが混入したレスポンスは即座に破棄。
2.  **Step 2 (Execution)**: プログラムがKataGoを実行。データ不備があればGeminiにマイクを渡さず終了。
3.  **Step 3 (Explanation)**: **Context Reset**を実施。過去の履歴を捨て、最新の事実データ（勝率・座標）のみを注入して解説を生成。
4.  **Hard Guard**: 生成文に「勝率(%)」と「推奨座標」が含まれない場合は捏造と断じ、表示をブロックする。

## 5. 知識ベースの活用規約
- **効率的参照**: 起動時に知識ベースをメモリにロード（キャッシュ）し、推論ごとのディスクI/Oを排除する。
- **例題ルール**: 知識ベース内の座標（E6等）は「サンプル」であり、回答への混入を厳禁とする。
- **着手番号の義務化**: 用語を指摘する際は、履歴内の具体的な着手番号（例：黒#15）との紐付けを必須とする。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **Black Perspective Policy**: KataGoからの出力はドライバー層で即座に「黒番視点」に正規化され、以降の全レイヤー（GameState, Storage, UI）で一貫して保持される。
- 手番による反転処理は、データの生成・保存の瞬間にのみ行い、GUI層やAI Engine層では一切の計算・反転を行わない。

## 7. 開発デバッグ・堅牢性指針
- **Atomic Storage**: JSON保存は一時ファイルへの書き込み完了後にリネームを行うことで、読み込み中の破損を物理的に防ぐ。
- **詳細ログ・トレーサビリティ**: `katago_debug.log`（エンジンの詳細）と `katago_err.log`（パースエラー等の異常系）を分離し、トラブルシューティングを迅速化する。
- **非同期UI**: ThreadPoolExecutor を活用し、解析中もUIの応答性を維持する。
- **リソースクリーンアップ**: アプリ終了時にワーカースレッドとエンジンプロセスを確実に停止させる。
