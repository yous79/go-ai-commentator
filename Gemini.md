# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 5.1

## 1. ビジョン (Vision)
KataGoの正確な計算とGemini 3の知性を融合させ、級位者が「納得」できる対話型解説体験を提供する。

## 2. アーキテクチャとデータ管理 (Data Management Strategy)
複雑なSGFツリー構造に依存せず、表示の整合性を100%保証するため「二重化戦略」を採用する。

### 2.1 データの保持
- **SGFツリー**: ファイル保存・読み込み時のみ使用する「永続化レイヤー」。
- **内部辞書 (marks_data)**: アプリ動作中のマーク操作・表示に使用する「ランタイムレイヤー」。`{ move_idx: { type: set(coords) } }` の形式で、各手番とデータを1対1で直結させる。

### 2.2 描画エンジンの標準 (Symbol Standard)
- **描画順序**: `Grid -> Stones -> Numbers -> Marks` の順序を厳守し、マークを最前面に描画する。
- **配色ルール**:
    - 黒石の上：**白 (white)** のマーク
    - 白石の上・空点：**黒 (black)** のマーク
- **視認性**: マークの線太さは `width=5` 以上を基準とし、PILの描画エラーを防ぐため座標は必ず `int()` に変換して渡す。

## 3. AI解説生成プロトコル (Manual 3-Step Execution)
ハルシネーションと無限ループを物理的に封殺するため、以下の「手動3段階実行」を維持する。
1. **Force Phase**: `mode='ANY'` と手動スキーマ定義で `FunctionCall` を強制。
2. **Execution Phase**: Python側でツールを1回のみ実行。
3. **Generation Phase**: `mode='NONE'` で文脈を上書きし、解析データに基づく解説を生成。

## 4. プロンプト・エンジニアリング規約
- **Blindness Strategy**: Step 1で「盤面が見えていない」と定義し、ツール使用を不可避にする。
- **Passive Reference Rule**: 知識ベースの用語は、局面やPVに実際に現れている場合のみ言及する。
- **履歴の最適化**: テキスト履歴は直近50手に制限し（解析は全手順）、生成速度を維持する。

## 5. テストプレイ・モードの定義
- 解析機能を介さない純粋な「検討・図作成」用の軽量インターフェース（test_play.py）。
- **インタラクティブ操作**: 石の配置、パス、Undo、および3種（□、△、×）のマーク付けをサポート。
- **図の保存**: 知識ベース作成用に、ステータスバーを除いた純粋な盤面図をPNG出力する機能。

## 6. 開発デバッグ・マニフェスト
- **生存確認ログ**: `DEBUG: Click at...`, `DEBUG RENDERER: ...` といったログを各レイヤーに配置し、データの到達を可視化する。
- **文字コード**: Windows環境対策として、全入出力・通信において `encoding='utf-8'` を徹底する。
