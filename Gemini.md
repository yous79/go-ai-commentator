# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 11.1

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。
3.  **解説の論理的深度の向上**: **ハイブリッド検知**（現状解析＋将来予測解析）により、盤面の物理的状況と戦略的意味を完全に同期させる。

## 2. アーキテクチャ定義 (Modular MVC & Hybrid Agent)
システムは、プログラムによる「確定事実の抽出」と、AIによる「動的な解釈」の二段構えで構成される。

- `src/core/`: 
    - `GameState`, `CoordinateTransformer`: 基盤ロジック。
    - **`ShapeDetector`**: アキ三角やサカレ形、ポン抜き等の幾何学的パターンを検知する。
- `src/services/`:
    - **`AICommentator`**: 
        - **履歴ベースの盤面復元**: 外部の共有状態に依存せず、着手履歴からその都度、盤面オブジェクトを動的に復元。解析中の副作用を完全に排除する。
- `src/gui/`: ThreadPoolExecutorによる非同期管理。
- `src/drivers/`: Double-Checked Lockingによるスレッドセーフなシングルトン。

## 3. シングルトン・エンジン・プロトコル
PCリソースの競合を防ぎ、通信の安定性を担保するため、1つのKataGoプロセスをアプリ全体で共有する。

## 4. AI解説生成：統合知能プロトコル (Integrated Intelligence)
1.  **事実先行 (Facts First)**: Geminiが思考を開始する前に、システムが現状の盤面を幾何学的に解析する。
2.  **予測的形状解析 (Predictive Shape Analysis)**: 
    - **独立シミュレーション**: 各候補手の変化図（PV）に対し、現在の盤面を起点とした独立した仮想環境で手順を進め、将来の形状変化を予見する。
    - **メタデータ注入**: 予測結果は `future_shape_analysis` としてGeminiに提供される。
3.  **副作用の完全排除**: 将来予測のシミュレーションが現在の盤面状態を破壊しないよう、オブジェクトのコピーとステートレスな処理を徹底する。
4.  **文脈の永続化**: 過去の履歴を保持し、一貫性のある指導を行う。

## 5. 知識ベースの活用・検知規約
- **厳格な出現判定**: 検知した形については必ず言及し、未検知の形については原則言及を禁止する。
- **ポン抜き（打ち上げ連動型）**: 「相手の石が1つ消えた」という手順上の事実と周囲の配置を組み合わせて判定する。
- **サカレ形（貫通重視）**: 「直線的な貫通」を条件とし、コスミ等の連絡がある場合は除外する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、各コンポーネントは必要に応じて履歴から自律的に盤面を再構築する。
- **Black Perspective Policy**: すべての解析データは「黒番視点」に正規化する。

## 7. 開発デバッグ・堅牢性指針
- **自動起動検証 (Automated Startup Test)**: 
    - 修正後は必ず `python src/utils/check_startup.py` を実行し、合格を確認すること。
- **Atomic Storage**: JSON保存は一時ファイル経由で行う。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **戦略的ストーリーテリング**: 数値の羅列を避け、「石の働き」を物語的に解説する。
- **候補手比較**: なぜ最善手が優れているのか、他図との比較を通じて論理化させる。
- **将来予測の活用**: PVの先で起きる好形・悪形を根拠に、着手の是非を語らせる。