# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 15.0

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。
3.  **解説の論理的深度の向上**: **「事実先行型」アーキテクチャ**により、AIの知性を正確なデータで裏付け、高度な対話指導を実現する。

## 2. アーキテクチャ定義 (Fact-First Platform)
システムは、**「事実（Facts）」をプログラムが確定させ、それを「解釈（Reasoning）」としてAIが語る**、責務を明確化した設計を採用する。

- **`src/services/AICommentator`**: 
    - **Fact-First Engine**: Geminiを起動する前に KataGo API を呼び出し、勝率、目数、形状検知などの客観的事実を完全に揃える。
- **`src/katago_api.py` (Intelligence Infrastructure)**: 
    - 唯一のエンジンプロセスを管理し、一貫した解析データ（黒番視点）を提供する。
- **`src/core/knowledge_manager.py`**: 
    - 知識ベースをインデックス化し、局面に応じた最適な知識をAIに提供する。

## 3. エンジン・マネジメント・プロトコル
- **プロセスの完全分離**: すべての解析は `localhost:8000` (katago_api) を唯一の窓口とし、リソースの奪い合いを防止する。
- **高可用性**: APIサーバーはリトライロジックを備え、負荷時でも安定した応答を保証する。

## 4. AI解説生成：事実先行プロトコル (Fact-First Protocol)
**「AIに探させる」のではなく「AIに事実を渡して語らせる」方式への完全移行。**

1.  **先行解析 (Pre-Analysis)**:
    - ユーザーの要求に対し、プログラムが自律的に解析ツールを実行し、以下の確定事実を取得する。
        - 局面評価（勝率、目数差）
        - 最善手とその変化図、および将来の形状予測。
        - 現局面の幾何学的形状（アキ三角、ポン抜き等）。
2.  **事実の文脈注入 (Fact Injection)**:
    - 取得したデータをプロンプトの最上部に【引用必須の確定データ】として配置。AIに対し「数字を予想・捏造する」動機を物理的に排除する。
3.  **純粋な解釈フェーズ**:
    - AIは提供された正確なデータをどう級位者に納得させるかという、戦略的言語化（意味付け）に全エネルギーを集中する。

## 5. 知識ベースの活用・検知規約
- **階層化管理**: 知識を「悪形・失着（重要）」と「一般手筋（一般）」に分類。
- **ハイブリッド検知**: `ShapeDetector` が抽出した事実に対し、AIがその「戦略的な理由」を知識ベースを引用して解説する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、必要に応じて動的に復元する。
- **Black Perspective (Standardized)**: API出力のキー名を `winrate_black`, `score_lead_black` に固定し、AIの推測による視点逆転を防止する。

## 7. 開発デバッグ・堅牢性指針
- **自動起動検証 (Automated Startup Test)**: 修正後は必ず `python src/utils/check_startup.py` を実行し、合格を確認すること。
- **捏造防止ガード (Hallucination Audit)**: 生成された解説文内の数値が、先行取得した事実データと一致するかを自動照合する。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **表現の具体化**: 「重い・軽い」を禁止し、「強い石・弱い石」という明確な用語を使用する。
- **物語としてのデータ引用**: 数値を単に読み上げるのではなく、その数値が局面においてどのような戦略的意味を持つのかを深く言語化させる。
- **将来予測の活用**: PVの先で起きる事実（好形・悪形）を根拠に、着手の是非を論理的に語らせる。
