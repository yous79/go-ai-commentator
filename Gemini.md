# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 16.0

## 1. ビジョンと絶対目標 (Vision & Core Goals)
KataGoの精密な計算（読み）とGemini 3の戦略的知性を融合させ、級位者が論理的に「納得」できる対話型解説体験を提供する。

### 1.1 最優先開発目標
1.  **座標の100%正確な認識**: 盤面上の石の位置や座標を1点の狂いもなく把握し、解説に反映させる。
2.  **愚形の論理的説明**: 知識ベースに基づき「なぜ悪いか」を級位者の言葉で論理的に説明する。
3.  **解説の論理的深度の向上**: 事実先行型アーキテクチャにより、AIの知性を正確なデータで裏付け、高度な対話指導を実現する。

## 2. アーキテクチャ定義 (Service-Oriented Intelligence Hub)
システムは、常駐APIを中心に、非同期ワーカーと動的UIが協調する高度なハブ構造を採用する。

- **`src/katago_api.py` (Intelligence Infrastructure)**: 
    - 唯一のエンジンプロセスを管理。複数クライアントからの並列リクエストを効率的に処理する。
- **`src/services/AnalysisManager`**: 
    - **Parallel Batch Runner**: ThreadPoolExecutor を活用し、SGF全体の解析を並列実行して高速化。
- **`src/gui/`**: 
    - **Interactive Dashboard**: Matplotlib による勝率グラフを統合した `InfoView` により、対局全体を俯瞰・操作可能。

## 3. エンジン・マネジメント・プロトコル
- **プロセスの完全分離**: すべての解析は `localhost:8000` (katago_api) を唯一の窓口とし、リソースの奪い合いを防止する。
- **リソース競合の解決**: APIサーバー側でリトライロジックを備え、複数クライアントからの要求を安全に処理する。

## 4. AI解説生成：事実先行プロトコル (Fact-First Protocol)
1.  **先行解析 (Pre-Analysis)**: ユーザーの要求に対し、プログラムが自律的に解析ツールを実行し、勝率、目数、形状予測、幾何学的形状等の確定事実を取得する。
2.  **事実の文脈注入 (Fact Injection)**: 取得したデータをプロンプトの最上部に配置。AIに対し「数字を予想・捏造する」動機を物理的に排除する。
3.  **純粋な解釈フェーズ**: AIは提供された正確なデータをどう級位者に納得させるかという、戦略的言語化（意味付け）に集中する。

## 5. 知識ベースの活用・検知規約
- **階層化管理**: 知識を「悪形・失着（重要）」と「一般手筋（一般）」に分類。
- **ハイブリッド検知**: `ShapeDetector` が抽出した事実に対し、AIがその理由を知識ベースを引用して解説する。

## 6. データ整合性の鉄則 (Single Source of Truth)
- **History as Truth**: 盤面状態の正解は常に「着手履歴」にあり、必要に応じて動的に復元する。
- **Partial Data Resilience**: 並列解析中はデータが不完全な（穴あき）状態であることを前提とし、各コンポーネントは `None` 値を安全にスキップまたは補完しなければならない。

## 7. 開発デバッグ・堅牢性指針 (Robustness & Resilience)
- **非同期例外の可視化**: すべてのバックグラウンドタスクは `traceback.print_exc()` による例外出力を行い、「沈黙するエラー」を徹底排除する。
- **自動起動検証 (Automated Startup Test)**: 修正後は必ず `python src/utils/check_startup.py` を実行し、合格を確認すること。
- **捏造防止ガード (Hallucination Audit)**: 生成された解説文内の数値が、事実データと一致するかを自動照合する。

## 8. 解説品質向上への注力事項 (Commentary Quality Focus)
- **視覚的コンテキストの統合**: 勝率グラフ上の変化点（急落・急騰）をクリックすることで、その瞬間の事実と紐付けた深い検討を可能にする。
- **表現の具体化**: 「重い・軽い」を禁止し、「強い石（安定）」「弱い石（不安定）」という用語を使用する。
- **将来予測の活用**: 変化図の先で起きる事実を根拠に、着手の是非を論理的に語らせる。