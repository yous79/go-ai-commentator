# 囲碁AI解説システム 統合仕様書 (Gemini.md) - Rev. 4.1

## 0. 最優先原則 (THE ABSOLUTE RULE)
**【解析データ未参照の解説生成は厳禁】**
Geminiは、必ず `consult_katago_tool` を実行し、その返り値（勝率、目数、PV）を直接の根拠として解説しなければならない。
- ツールを呼び出していない回答は、内容に関わらず「不正」とみなす。
- ツールがエラーを返した場合、またはデータが空の場合、Geminiは独自の推測（ハルシネーション）を述べてはならず、正直に「データ不足のため解析不能」と回答を終了しなければならない。

## 1. 開発ミッション
KataGoの正確な「読み」と、Gemini 3の高度な「推論・言語能力」を融合させ、大人の級位者が論理的に納得できる囲碁解説体験を提供する。

## 2. 厳守すべき実装・文法ルール (Anti-Bug Manifesto)
- **対話言語**: ユーザーとのCLI上でのやり取り、および解説文の生成はすべて**日本語**で行うこと。
- **1行1命令の徹底**: セミコロン（`;`）による命令結合を全面的に禁止。
- **例外処理の安全性**: `except Exception as e` の `e` は必ず文字列に変換してから使用。
- **インデントの整合性**: 常に標準的なPythonインデントを維持。

## 3. 技術スタック & SDK実装仕様 (Manual 3-Step Execution)
無限ループとハルシネーションを同時に解決するため、以下の**「手動3段階実行」**を唯一の実装標準とする。

### Step 1: 強制呼び出し (Force Phase)
- **手動スキーマ定義**: `tools` には関数実体（callable）ではなく、`types.Tool` を用いて手動定義したスキーマのみを渡す。
- **強制モード**: `tool_config` で `mode='ANY'` を指定し、ツール呼び出しを強制する。

### Step 2: 手動実行 (Execution Phase)
- Python側で `FunctionCall` を受け取り、`consult_katago_tool` を実行してデータを取得する。

### Step 3: 解説生成 (Generation Phase)
- 「プロンプト」「ツール命令」「実行結果」を履歴に含め、`tools` 設定を解除して解説文を生成させる。
- **知識ベースの融合**: 解析データ（勝率・PV）を、システム指示に含まれる**知識ベース（knowledge）**と照らし合わせ、「なぜその手が良い/悪いのか」を用語を用いて論理的に説明する。

## 4. 囲碁ロジック & 知識ベース活用 (ハルシネーション防止)
- **Blindness Strategy**: 「盤面が見えていない」と定義し、ツールデータなしの回答を物理的に封殺する。
- **受動的参照の徹底**: 知識ベースの用語（例：「サカレ形」「アキサンカク」）は、**現状または変化図に出現した時のみ**言及する。無関係な場面での知識披露は禁止。
- **論理的接続**: 「勝率が下がった（データ）」＋「石が裂かれた形になった（知識）」のように、データと知識を直結させて解説する。

## 5. 座標と変化図の明示
- 解説内では必ず具体的な座標（例：Q16、P15）や、変化図（PV）の展開に触れ、読者が盤面上を追えるようにすること。
