# ウォークスルー - ヒートマップと候補手可視化のデバッグ

ヒートマップが表示されない問題と、候補手の表示が重なったり巨大化したりする問題を解決しました。主な原因は、KataGoエンジンのレスポンス形式に対する誤った想定と、古い描画ロジックの干渉でした。

## 主な変更点

### `src/drivers/katago_driver.py`

- **パースロジックの修正**: `ownership`（地合予測）データが `rootInfo` の中にあると想定していましたが、実際にはJSONレスポンスのトップレベル（`rootInfo` の兄弟）にありました。
- **堅牢性の向上**: トップレベルと `rootInfo` 内の両方をチェックするようにし、異なるバージョンのKataGoとの互換性を確保しました。

### `src/utils/renderer/renderer.py`

- **動的なフォントサイズ**: グリッドサイズに基づいてフォントサイズを計算するロジック（`max(10, int(gs * 0.35))`）を導入しました。これにより、19路盤でも9路盤でも適切な大きさで数字が表示されます。

### `src/utils/renderer/layers/analysis_layer.py`

- **サイズの最適化**: 候補手の円の半径を升目の80%に調整し、隣り合う地点との重なりを防ぎ、視認性を高めました。
- **レンダリングの高速化**: 候補手ごとにレイヤーを作成するのではなく、一度のパスで全候補手を処理するように最適化しました。
- **スタイルの改善**: 半透明の塗りつぶしと細い枠線を採用し、盤面の石と調和するデザインにしました。

### `src/gui/app.py`

- **二重描画の解消**: `BoardView` への候補手データの受け渡しを停止しました。これにより、古い描画ロジックと新しいレンダラーが干渉して数字が巨大化したり、位置がズレたりする問題を根本から解決しました。

### 解析設定

- **エンジンログの有効化**: `analysis.cfg` で `logAllResponses = true` を一時的に有効にし、KataGoの生のJSON出力を解析することで、パースエラーの特定を行いました。

### 自動化

- **`auto_test.py`**: アプリを起動して特定のSGFを自動ロードするスクリプトを作成しました。これにより、修正後の動作確認を迅速に行えるようになりました。

## 検証結果

### ログ解析による確認
修正後、`ownership` データが正しくパースされ、GUIレイヤーまで伝達されていることをログで確認しました。

**修正前:**
```
API RAW DATA: Keys=[...], OwnType=<class 'NoneType'>, OwnLen=N/A
```

**修正後:**
`analysis.log` および内部デバッグログにより、正しい数値配列が取得できていることを確認しました。

### 視認による確認
ヒートマップ（地合予測）が正しい向き（上下反転なし）で表示され、候補手が適切なサイズと正確な位置に描画されることを `auto_test.py` で確認済みです。
